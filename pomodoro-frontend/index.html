<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pomodoro Timer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
    }
    #timer {
      font-size: 10rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="d-flex align-items-center justify-content-between mb-4">
      <h1 class="mb-0">Synced Pomodoro Timer</h1>
      <div id="soundWarning" class="text-muted ms-3">
        <i class="bi bi-volume-mute"></i> Sound is muted until you interact
      </div>
    </header>
    <main class="d-flex flex-column justify-content-center align-items-center" style="min-height: 70vh;">
    <div class="mb-3">
      <div class="input-group">
        <input type="text" id="sessionId" class="form-control" placeholder="Enter session name" />
        <button class="btn btn-primary" onclick="connect()">Join Session</button>
      </div>
    </div>

    <div class="mt-3 d-flex justify-content-center">
      <button class="btn btn-outline-primary me-4" onclick="setTimeFromPreset('pomodoro')" 
            data-bs-toggle="tooltip" data-bs-placement="top" 
            data-bs-original-title="Pomodoro time: -- min" 
            onmouseenter="this.setAttribute('data-bs-original-title', 'Pomodoro time: ' + document.getElementById('presetPomodoro').value + ' min')">Pomodoro</button>
      <button class="btn btn-outline-primary me-4" onclick="setTimeFromPreset('shortBreak')" 
            data-bs-toggle="tooltip" data-bs-placement="top" 
            data-bs-original-title="Short Break time: -- min" 
            onmouseenter="this.setAttribute('data-bs-original-title', 'Short Break time: ' + document.getElementById('presetShortBreak').value + ' min')">Short Break</button>
      <button class="btn btn-outline-primary" onclick="setTimeFromPreset('longBreak')" 
            data-bs-toggle="tooltip" data-bs-placement="top" 
            data-bs-original-title="Long Break time: -- min" 
            onmouseenter="this.setAttribute('data-bs-original-title', 'Long Break time: ' + document.getElementById('presetLongBreak').value + ' min')">Long Break</button>
    </div>

    <script>
      // Initialize tooltips and bind audio unlock on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', () => {
        const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(tooltipTriggerEl => {
          new bootstrap.Tooltip(tooltipTriggerEl, {
            delay: { show: 500, hide: 0 }
          });
        });
        // Bind audio unlock on first user interaction
        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('keydown', unlockAudio, { once: true });
      });

      // WebSocket and timer variables
      let ws;
      let remaining = 0;
      let isRunning = false;
      let audioUnlocked = false;
      let muteChime;

      function initWebSocket() {
        ws = new WebSocket('wss://pomodoro-be.ytkacpersky.de');
        ws.onopen = () => {
          const autoSessionId = getSessionIdFromUrlOrStorage();
          if (autoSessionId) {
            document.getElementById('sessionId').value = autoSessionId;
            connect();
          }
          setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: 'ping' }));
            }
          }, 5000);
        };

        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === 'timer') {
            remaining = msg.timer.remainingTime;
            isRunning = msg.timer.isRunning;
            updateDisplay();

            if (msg.timer.presets && !document.getElementById('presetsModal').classList.contains('show')) {
              document.getElementById('presetPomodoro').value = parseTimeToString(msg.timer.presets.pomodoro);
              document.getElementById('presetShortBreak').value = parseTimeToString(msg.timer.presets.shortBreak);
              document.getElementById('presetLongBreak').value = parseTimeToString(msg.timer.presets.longBreak);
            }
          } else if (msg.type === 'error') {
            console.log(msg.message);
          }
        };

        ws.onclose = () => {
          document.getElementById('timer').textContent = '--:--';
        };
      }

      function parseTimeToString(seconds) {
        const minutes = seconds / 60;
        return (minutes % 1 === 0) ? minutes.toString() : minutes.toFixed(1);
      }

      function getSessionIdFromUrlOrStorage() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id') || localStorage.getItem('lastSessionId');
      }

      function connect() {
        if (ws?.readyState !== WebSocket.OPEN) {
          window.location.reload();
          return;
        }
        let sessionId = document.getElementById('sessionId').value.trim();
        if (!sessionId) {
          sessionId = getSessionIdFromUrlOrStorage();
          if (!sessionId) {
            alert('Please enter a session name.');
            return;
          }
          document.getElementById('sessionId').value = sessionId;
        }
        localStorage.setItem('lastSessionId', sessionId);
        ws.send(JSON.stringify({ type: 'joinSession', sessionId }));
        document.getElementById('controls').classList.remove('d-none');
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('id', sessionId);
        window.history.replaceState({}, '', newUrl);
      }

      window.onload = initWebSocket;

      function updateDisplay() {
        const minutes = Math.floor(remaining / 60).toString().padStart(2, '0');
        const seconds = (remaining % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        
        // Update the tab title with the timer
        document.title = `[${minutes}:${seconds}] Pomodoro Timer`;

        if (remaining === 0 && isRunning) {
          const chime = new Audio('chime.mp3');
          chime.play();
        }
        const toggleBtn = document.getElementById('toggleButton');
        if (toggleBtn) {
          toggleBtn.textContent = isRunning ? 'Pause' : 'Start';
          toggleBtn.className = isRunning ? 'btn btn-outline-warning mb-3 me-1' : 'btn btn-outline-success mb-3 me-1';
        }
      }

      function startTimer() {
        ws.send(JSON.stringify({ type: 'startTimer' }));
      }

      function pauseTimer() {
        ws.send(JSON.stringify({ type: 'pauseTimer' }));
      }

      function resetTimer() {
        ws.send(JSON.stringify({ type: 'resetTimer' }));
      }

      function toggleTimer() {
        if (isRunning) {
          pauseTimer();
        } else {
          startTimer();
        }
      }

      function setTime() {
        const remainingTime = parseInt(document.getElementById('setTimeSeconds').value, 10);
        if (isNaN(remainingTime) || remainingTime <= 0) {
          alert('Enter a valid time in seconds.');
          return;
        }
        ws.send(JSON.stringify({ type: 'setTime', remainingTime }));
      }

      function setTimeFromPreset(type) {
        const inputIdMap = {
          pomodoro: 'presetPomodoro',
          shortBreak: 'presetShortBreak',
          longBreak: 'presetLongBreak'
        };
        const str = document.getElementById(inputIdMap[type])?.value;
        const remainingTime = parseStringToTime(str);
        if (remainingTime === null) {
          alert('Invalid time format in presets.');
          return;
        }
        ws.send(JSON.stringify({ type: 'setTime', remainingTime }));
      }

      function updatePresets() {
        const pomodoro = parseStringToTime(document.getElementById('presetPomodoro').value);
        const shortBreak = parseStringToTime(document.getElementById('presetShortBreak').value);
        const longBreak = parseStringToTime(document.getElementById('presetLongBreak').value);

        if (pomodoro === null || shortBreak === null || longBreak === null) {
          alert("All preset fields must be valid numbers.");
          return;
        }

        ws.send(JSON.stringify({
          type: "setPresets",
          pomodoro,
          shortBreak,
          longBreak
        }));
      }

      function parseStringToTime(str) {
        str = str.trim();
        const minutes = parseFloat(str);
        if (isNaN(minutes)) return null;
        return Math.round(minutes * 60);
      }

      function unlockAudio() {
        if (audioUnlocked) return;
        muteChime = new Audio('mutedChime.wav');
        muteChime.play().then(() => {
          audioUnlocked = true;
          document.getElementById('soundWarning').style.display = 'none';
        }).catch((err) => {
          console.warn('Audio not yet allowed:', err);
        });
      }

      // Modal focus handling to prevent aria-hidden warnings
      const presetsModal = document.getElementById('presetsModal');
      const gearButton = document.querySelector('[data-bs-target="#presetsModal"]');
      presetsModal.addEventListener('hidden.bs.modal', () => {
        if (gearButton) {
          gearButton.focus();
        }
      });
    </script>

    <div id="controls" class="d-none">
      <div id="timer" class="mb-3">--:--</div>
      <div class="d-flex justify-content-center">
        <button id="toggleButton" class="btn mb-3 me-3" style="width: 75px" onclick="toggleTimer()"></button>
        <button class="btn btn-outline-danger mb-3 me-1" onclick="resetTimer()">
          <i class="bi bi-arrow-counterclockwise"></i>
        </button>
        <button class="btn btn-outline-secondary mb-3" data-bs-toggle="modal" data-bs-target="#presetsModal">
          <i class="bi bi-gear"></i>
        </button>
      </div>
    </div>
    
    </main>
  </div>

  <!-- Presets Modal -->
  <div class="modal fade" id="presetsModal" tabindex="-1" aria-labelledby="presetsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="presetsModalLabel">Edit Presets</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="presetPomodoro" class="form-label">Pomodoro</label>
            <div class="input-group">
              <input type="number" class="form-control" id="presetPomodoro" />
              <span class="input-group-text">min</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="presetShortBreak" class="form-label">Short Break</label>
            <div class="input-group">
              <input type="number" class="form-control" id="presetShortBreak" />
              <span class="input-group-text">min</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="presetLongBreak" class="form-label">Long Break</label>
            <div class="input-group">
              <input type="number" class="form-control" id="presetLongBreak" />
              <span class="input-group-text">min</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="updatePresets()" data-bs-dismiss="modal">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>